<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta content="en-gb" http-equiv="Content-Language" />
<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
<title>Introduction</title>
</head>

<body>

<ul>
	<li><a href="#Introduction">Introduction</a></li>
	<li><a href="#Demo-App-Code">Demo App Code</a></li>
	<li><a href="#Some-Actor-Background-Waffle">Some Actor Background Waffle</a></li>
	<li><a href="#Tell-Me-More-About-This-Actor-Shennanigans">Tell Me More About This Actor Shennanigans</a></li>
	<li><a href="#What-Is-An-Actor-Model?">What Is An Actor Model?</a></li>
	<ul>
		<li><a href="#Multi-Threaded-Application-Using-Shared-Data-Structure">Multi Threaded Application Using Shared Data Structure</a></li>
		<li><a href="#Actor-Model">Actor Model</a></li>
	</ul>
	<li><a href="#Akka.Net">Akka.Net</a></li>
	<li><a href="#Training-Guide">Training Guide</a></li>



	<li><a href="#Akka.NET-And-Demo-App">Akka.NET And Demo App</a></li>
	<ul>
		<li><a href="#The-Actor-System">The Actor System</a></li>
		
		<li><a href="#Props---Creating-A-New-Actor">Props - Creating A New Actor</a></li>
		
		<li><a href="#Props---Creating-Child-Actors">Props - Creating Child Actors</a></li>
		
		<li><a href="#Supervision">Supervision</a></li>
		
		<li><a href="#ActorRef">ActorRef</a>
		<ul>
			<li><a href="#Special-ActorRefs">Special ActorRefs</a></li>
			
			<li><a href="#Actor-Selection">Actor Selection</a></li>
		
		</ul>
		<li><a href="#Sending-Messages">Sending Messages</a></li>
		
		<li><a href="#Asking">Asking</a></li>
		
		<li><a href="#Special-Message-Types">Special Message Types</a>
		<ul>
			<li><a href="#PoisonPill.Instance">PoisonPill.Instance</a></li>
			
			<li><a href="#Kill.Instance">Kill.Instance</a></li>
		
		</ul>
		
		<li><a href="#Lifecycle-Methods">Lifecycle Methods</a></li>
		
		<li><a href="#Logging">Logging</a></li>
		
		<li><a href="#Testing">Testing</a></li>
		
		<li><a href="#The-Actual-Demo-App">The Actual Demo App</a></li>
		
</ul>

<li><a href="#That's-It">That's It</a></li>

</ul>



<h1>&nbsp;</h1>
<h1><a name="Introduction" id="Introduction">Introduction</a></h1>
<p>A while back I became quite interested in messaging, I have always used 
things like Signalr,WCF, MSMQ, and NServiceBus, which are all cool tech for 
sure. I did however, feel I wanted to learn a bit more, so spent quite a few 
months experimenting with thing like</p>
<p>&nbsp;</p>
<ul>
	<li>EasyMQ (RabbitMQ based servicebus stylee API)</li>
	<li>Azure ServiceBus</li>
	<li>NetMQ</li>
</ul>
<p>&nbsp;</p>
<p>Whilst in this messaging stage of my life I came across something that really 
spiked my interest which is the use of&nbsp; "Actor(s)" for distributed 
programming. Actors pop up in various frameworks such as:</p>
<ul>
	<li><a href="https://github.com/dotnet/orleans" target="_blank">Microsoft 
	Orleans</a> : Distributed Virtual Actor Model</li>
	<li>
	<a href="https://www.google.co.uk/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=2&amp;cad=rja&amp;uact=8&amp;ved=0CCgQFjAB&amp;url=http%3A%2F%2Fdownload.microsoft.com%2Fdownload%2FB%2FD%2F5%2FBD51FFB2-C777-43B0-AC24-BDE3C88E231F%2FAxum%2520Programmers%2520Guide.pdf&amp;ei=4deUVdDXE4HN7QaW7I-AAw&amp;usg=AFQjCNEgP-7XJiXae6Cws6TAtOfHDZ3ktw&amp;sig2=k7dtANcOlMXDtyBAng-h5A&amp;bvm=bv.96952980,d.ZGU" target="_blank">
	Microsoft Axum</a> : A research project, which never made it into production 
	which I think is sad</li>
	<li><a href="http://akka.io/" target="_blank">Akka</a> : Java / Scala based 
	Actor model</li>
	<li><a href="http://getakka.net/" target="_blank">Akka.NET</a> : .NET port 
	of Akka</li>
</ul>
<p>&nbsp;</p>
<p>This article will be about using
<a href="http://getakka.net/" target="_blank">Akka.NET</a> which is a pretty 
complete port of the original <a href="http://akka.io/" target="_blank">Akka</a>, 
so you will pretty much see how that works by the end of this too I hope.</p>
<p>&nbsp;</p>
<h1><a name="Demo-App-Code" id="Demo-App-Code">Demo App Code</a></h1>
<p>You can grab the demo code for this article from my github account : 
<a href="https://github.com/sachabarber/AkkaWintail">
https://github.com/sachabarber/AkkaWintail</a></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h1><a name="Some-Actor-Background-Waffle" id="Some-Actor-Background-Waffle">Some Actor Background Waffle</a></h1>
<p>This is not the 1st time I have written about Actor models, in fact a while 
back I wrote quite a long post (which is good background reading) about an Actor 
model that I wrote for NetMQ (the .NET port of ZeroMQ). You can read that post 
here:</p>
<p>
<a href="https://sachabarbs.wordpress.com/2014/09/05/zeromq-7-a-simple-actor-model/">
https://sachabarbs.wordpress.com/2014/09/05/zeromq-7-a-simple-actor-model/</a></p>
<p>
&nbsp;</p>
<p>I was very pleased but this actually made its way into the the actual NetMQ 
codebase, and is fully documented here:</p>
<p>
<a href="http://netmq.readthedocs.org/en/latest/actor/">
http://netmq.readthedocs.org/en/latest/actor/</a></p>

<p>This next bit of text is lifted directly from the post/documentation that I 
had previous written, though you should still read those if you are interested 
in seeing the specific NetMQ implementation works.</p>
<p>Anyway lets dive it shall we........</p>
<p>&nbsp;</p>
<p>&nbsp;</p>

<h2><a name="Tell-Me-More-About-This-Actor-Shennanigans" id="Tell-Me-More-About-This-Actor-Shennanigans">Tell Me More About This Actor Shennanigans</a></h2>
<p>&nbsp;</p>


<h3><a name="What-Is-An-Actor-Model?" id="What-Is-An-Actor-Model?">What Is An Actor Model?</a></h3>


<p>Here is what Wikipedia has to same in the introduction to what an Actor Model is.</p>

<p>The actor model in computer science is a mathematical model of concurrent computation that treats “actors” as the universal primitives of concurrent digital computation: in response to a message that it receives, an actor can make local decisions, create more actors, send more messages, and determine how to respond to the next message received.<p>
&nbsp;</p>
<p>
….
<br/>
….
</p>
<p>The Actor model adopts the philosophy that everything is an actor. This is similar to the everything is an object philosophy used by some object-oriented programming languages, but differs in that object-oriented software is typically executed sequentially, while the Actor model is inherently concurrent.</p>

<p>An actor is a computational entity that, in response to a message it receives, can concurrently:</p>

<p>
<ul>
	<li>send a finite number of messages to other actors</li>
	<li>create a finite number of new actors</li>
	<li>designate the behavior to be used for the next message it receives.
</li>
</ul>
</p>
<p>There is no assumed sequence to the above actions and they could be carried out in parallel.</p>
<p>Decoupling the sender from communications sent was a fundamental advance of the Actor model enabling asynchronous communication and control structures as patterns of passing messages.</p>
<p>Recipients of messages are identified by address, sometimes called “mailing address”. Thus an actor can only communicate with actors whose addresses it has. It can obtain those from a message it receives, or if the address is for an actor it has itself created.</p>
<p>The Actor model is characterized by inherent concurrency of computation within and among actors, dynamic creation of actors, inclusion of actor addresses in messages, and interaction only through direct asynchronous message passing with no restriction on message arrival order.</p>
<p>&nbsp;</p>

<p><a href="http://en.wikipedia.org/wiki/Actor_model" target="_blank">http://en.wikipedia.org/wiki/Actor_model</a></p>




<p>&nbsp;</p>
<p>How I like to think of Actors is that they may be used to alleviate some of 
synchronization concerns of using shared data structures. This is achieved by 
your application code talking to actors via message passing/receiving. The actor 
itself may pass messages to other actors, or work on the passed message itself. 
By using message passing rather than using shared data structures, it may help 
to think of the actor (or any subsequent actors its send messages to) working on 
a copy of the data rather than working on the same shared structures. Which kind 
of gets rid of the need to worry about nasty things like lock(s) and any nasty 
timing issues that may arise from carrying out multi threaded code. If the actor 
is working with its own copy of the data then we should have no issues with 
other threads wanting to work with the data the actor has, as the only place 
that data can be is within the actor itself, that is unless we pass another 
message to a different actor. If we were to do that though the new message to 
the other actor would also be a copy of the data, so would also be thread safe.</p>
<p>&nbsp;</p>
<p>I hope you see what I am trying to explain there, may be a diagram may help.</p>
<p>&nbsp;</p>
<h3><a name="Multi-Threaded-Application-Using-Shared-Data-Structure" id="<strong>Multi-Threaded-Application-Using-Shared-Data-Structure">Multi Threaded Application Using Shared Data Structure</a></h3>
<p>A fairly common thing to do is have multiple threads running to speed things 
up, but then you realise that your threads need to mutate the state of some 
shared data structure, so then you have to involve threading synchronization 
primitives (most commonly lock(..) statements, to create your user defined 
critical sections). This will work, but now you are introducing artificial 
delays due to having to wait for the lock to be released so you can run Thread 
X’s code.</p>
<p><img alt="" height="372" src="mtTYpical.png" width="589" /></p>
<p>To take this one step further, lets see some code that may illustrate this 
further, imagine we had this sort of data structure representing a very slim 
bank account</p>
<pre lang="cs">
namespace ConsoleApplication1
{
    public class Account
    {
        public Account()
        {

        }

        public Account(int id, string name, 
            string sortCode, decimal balance)
        {
            Id = id;
            Name = name;
            SortCode = sortCode;
            Balance = balance;
        }

        public int Id { get; set; }
        public string Name { get; set; }
        public string SortCode { get; set; }
        public decimal Balance { get; set; }
    }
}
</pre>
<p>Nothing fancy there, just some fields. So lets now move onto looking at some threading code, I have chosen to just show two threads acting on a shared Account instance.</p>
<pre lang="cs">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Management.Instrumentation;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
namespace ConsoleApplication1
{
    class Program
    {
        private object syncLock = new object();
        private Account clientBankAccount;
        public Program()
        {
            clientBankAccount = new Account(1,"sacha barber","112233",0);
        }

        public async Task Run()
        {
            try
            {
                await Task.Run(() =&gt;
                {
                    Console.WriteLine("Tread Id {0}, Account balance before: {1}", 
                        Thread.CurrentThread.ManagedThreadId, clientBankAccount.Balance);
                        
                    lock (syncLock)
                    {
                        Console.WriteLine("Tread Id {0}, Adding 10 to balance",
                           Thread.CurrentThread.ManagedThreadId);
                        clientBankAccount.Balance += 10;
                        Console.WriteLine("Tread Id {0}, Account balance before: {1}",
                            Thread.CurrentThread.ManagedThreadId, clientBankAccount.Balance);
                    }
                });

                await Task.Run(() =&gt;
                {
                    Console.WriteLine("Tread Id {0}, Account balance before: {1}",
                        Thread.CurrentThread.ManagedThreadId, clientBankAccount.Balance);
                    lock (syncLock)
                    {
                        Console.WriteLine("Tread Id {0}, Subtracting 4 to balance",
                           Thread.CurrentThread.ManagedThreadId);
                        clientBankAccount.Balance -= 4;
                        Console.WriteLine("Tread Id {0}, Account balance before: {1}",
                            Thread.CurrentThread.ManagedThreadId, clientBankAccount.Balance);
                    }
                });
            }
            catch (Exception e)
            {
                Console.WriteLine(e);
            }

        }

        static void Main(string[] args)
        {
           Program p = new Program();
           p.Run().Wait();
           Console.ReadLine();
        }
    }
}
</pre>
<p>
I have possible picked an example that you think may not actually happen in real life, and to be honest this scenario may not popup in real life, as who would do something as silly as crediting an account in one thread, and debiting it in another…we are all diligent developers, we would not let this one into the code would we?
</p>
<p>
<br/>
To be honest whether the actual example has real world merit or not, the point remains the same, since we have more than one thread accessing a shared data structure, access to it must be synchronized, which is typically done using a lock(..) statement, as can be seen in the code.
<br/>
Now don’t get me wrong the above code does work, as shown in the output below:
</p>
<p>
&nbsp;</p>
<p>
<img alt="" height="179" src="cons1.png" width="446" /></p>
<p>
Perhaps there might be a more interesting way though!</p>
<p>
&nbsp;</p>
<h3><a name="Actor-Model" id="Actor-Model">Actor Model</a></h3>

<p>The actor model, takes a different approach, where by message passing is used, which 
<strong>MAY</strong> involve some form of serialization as the messages are passed down the wire, which kind of guarantees no shared structures to contend with. 
</p>

<p>
&nbsp;</p>
<p>
<img alt="" height="388" src="actor1.png" width="587" /></p>
<p>
&nbsp;</p>
<p>
&nbsp;</p>
<p>
So that was a little introduction/catch up, so what will the rest of the article 
be about. Well the rest of the article will be about how to develop code in .NET 
which makes use of an Actor Model. We will be proceeding on to look at how to 
use&nbsp;
<a href="http://getakka.net/" target="_blank">Akka.NET</a>, I will not be 
covering a
<a href="http://getakka.net/" target="_blank">Akka.NET</a> version of the sample 
above but shall instead build apon a new
<a href="http://getakka.net/" target="_blank">Akka.NET</a> sample.</p>
<p>
&nbsp;</p>
<p>
&nbsp;</p>
<p>
&nbsp;</p>





<h1><a name="Akka.Net" id="Akka.Net">Akka.Net</a></h1>
<p>As stated already
<a href="http://getakka.net/" target="_blank">Akka.NET</a> is a direct port of <a href="http://akka.io/" target="_blank">Akka</a>, 
and its a pretty complete port at that.</p>
<p>&nbsp;</p>
<h2><a name="Training-Guide" id="Training-Guide">Training Guide</a></h2>
<p>There is a truly excellent training guide with start to finish examples that 
you can go through, where it is nicely broken up into bite sized labs, there are 
3 parts with around 6 labs in each. You can grab that from this url :</p>
<p>
<a href="https://github.com/petabridge/akka-bootcamp">https://github.com/petabridge/akka-bootcamp</a></p>
<p>&nbsp;</p>
<p>I <strong>strongly</strong> (see what I did there with my awesome <code>&lt;strong&gt;strongly&lt;/strong&gt;</code> html skills) you read this, and have a go.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h1><a name="Akka.NET-And-Demo-App" id="Akka.NET-And-Demo-App">Akka.NET And Demo App</a></h1>
<p>The rest of this article will be about 
<a href="http://getakka.net/" target="_blank">Akka.NET</a> internals, and also 
shall briefly talk about the demo app. I have shamelessly 
stolen the demo app from the completed part 1 labs from the
<a href="https://github.com/petabridge/akka-bootcamp">https://github.com/petabridge/akka-bootcamp</a> 
training guide. Its a great place to start, and the way I see it I am sharing 
the
<a href="http://getakka.net/" target="_blank">Akka.NET</a> love, so they would 
be happy. </p>
<p>I will of course be adding a bit of new stuff, which is not covered by the 
labs.</p>
<p>&nbsp;</p>
<h2><a name="The-Actor-System" id="The-Actor-System">The Actor System</a></h2>
<p>
<a href="http://getakka.net/" target="_blank">Akka.NET</a> is  
an actor framework for .NET.
<a href="http://getakka.net/" target="_blank">Akka.NET</a> is made up of a 
couple of system level actors (which are not within your control, they are part 
of
<a href="http://getakka.net/" target="_blank">Akka.NET</a>). These top level 
actors are known as "Guardians". You never really deal with these directly. 
Instead you are expected to create actors within one of the following 2 
contexts:</p>
<ol>
	<li>Within the context of the
<a href="http://getakka.net/" target="_blank">Akka.NET</a> actor system</li>
	<li>Within the context of an existing actor, where the newly created actor 
	will be a child actor of the context in which it is created. And as such 
	will be supervised by its parent (the chap within whos context this new 
	actor was spawned)</li>
</ol>
<p>&nbsp;</p>
<p>Lets see an example of how to create an actor within the actor system (don't 
worry for now if this looks weird, the <code>Props </code>stuff here will be explained in 
just a moment)</p>
<pre lang="cs">
// make actor system 
MyActorSystem = ActorSystem.Create("MyActorSystem"<span lang="en-gb">, config</span>);

// create top-level actors within the actor system
Props consoleWriterProps = Props.Create&lt;ConsoleWriterActor&gt;();
IActorRef consoleWriterActor = MyActorSystem.ActorOf(consoleWriterProps, "consoleWriterActor");

Props tailCoordinatorProps = Props.Create(() =&gt; new TailCoordinatorActor());
IActorRef tailCoordinatorActor = MyActorSystem.ActorOf(tailCoordinatorProps, "tailCoordinatorActor");

// blocks the main thread from exiting until the actor system is shut down
MyActorSystem.AwaitTermination();</pre>
<p>&nbsp;</p>
<p>It can be seen there is an
<a href="http://getakka.net/" target="_blank">Akka.NET</a> <code>ActorSystem
</code>which we are using here to create actors, where we use some strange <code>
Props </code>voodoo.. These actors will be supervised by the
<a href="http://getakka.net/" target="_blank">Akka.NET</a> guardians. Again we 
will get onto supervision in a while.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2><a name="Props---Creating-A-New-Actor" id="Props---Creating-A-New-Actor">Props - Creating A New Actor</a></h2>
<p><code>Props </code>is the object you use to create an actor. You <strong>MUST</strong> use 
<code>Props </code>to create an actor within the main <code>ActorSystem </code>or within the scope of another 
actor. But how can we use this <code>Props </code>thing?</p>
<p>There are different ways to create to create actors using <code>Props</code>, 
let's see a few examples.</p>
<p>&nbsp;</p>
<p>If the actor itself has a default constructor, we can use this form of Props</p>
<pre lang="cs">
Props consoleWriterProps = Props.Create&lt;ConsoleWriterActor&gt;();</pre>
<pre lang="cs">

</pre>
<p>If however the actor constructor expects parameters, we can use this form of Props</p>
<pre lang="cs">
Props someNonDefaultProps = Props.Create(() =&gt; new SomeNonDefaultActor(someDependency));
IActorRef someNonDefaultActor= MyActorSystem.ActorOf(someNonDefaultProps , "someNonDefaultActor");
</pre>
<p>&nbsp;</p>
<p>There is also another way where you add a static factory method to the actual 
actor class and have that return <code>Props</code>, and you make use of that. </p>
<p>&nbsp;</p>
<p>In all of these cases a thing called an <code>IActorRef </code>is returned. 
What's that I hear you ask. Well quite simply a <code>IActorRef </code>is a 
handle to an actor within the system. If you have a <code>IActorRef </code>to an 
actor, you can <code>Tell</code>/<code>Ask </code>that actor things. You can of course pass <code>
IActorRef</code>s about.</p>
<p>The other thing to note with the <code>Props </code>class, is that it acts as 
a way of capturing (via closures that capture the input parameters the 1st time the actor is 
created) the input parameters, such that the <code>Props </code>also act as a 
factory for recreating the actor should it die (either by programatic choice or 
via a supervising strategy).</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2><a name="Props---Creating-Child-Actors" id="Props---Creating-Child-Actors">Props - Creating Child Actors</a></h2>
<p>We have seen how to create actors in the overall
<a href="http://getakka.net/" target="_blank">Akka.NET</a> system, and I also 
elluded to the fact that you could create actors within the context of other 
actors. So how do you do that. Well it is quite simple, and it builds on the
<code>Props </code>stuff we just covered. Here is an example:</p>
<pre lang="cs">
public class TailCoordinatorActor : UntypedActor
{
    protected override void OnReceive(object message)
    {
        if (message is StartTail)
        {
            var msg = message as StartTail;
            Context.ActorOf(Props.Create(() =&gt; new TailActor(msg.ReporterActor, msg.FilePath)));
        }
    }
}</pre>
<p>The important line is this one</p>
<pre lang="cs"> Context.ActorOf(Props.Create(() =&gt; new TailActor(msg.ReporterActor, msg.FilePath)));</pre>
<p>As stated above when you use the <code>Conntext.ActorOf(..)</code> you are 
creating a new actor in the context of this actor. That means the newly created 
actor is a child of the current actor. As such, it becomes job of the current 
actor to "<strong>Supervise</strong>" this new child actor. We will talk more 
about this next.</p>
<p>&nbsp;</p>
<h2><a name="Supervision" id="Supervision">Supervision</a></h2>
<p>Within <a href="http://getakka.net/" target="_blank">Akka.NET</a> we now know 
that we can create our own heirarchies of actors. The leaf actors 
(subordinate(s))&nbsp; will be supervised by their parents and so on, all the 
way up through the <a href="http://getakka.net/" target="_blank">kka.NET</a> top level system 
actors (the "Guardians")</p>
<p>&nbsp;</p>
<p><em>When a subordinate detects a failure (i.e. throws an exception), it 
suspends itself and all its subordinates and sends a message to its supervisor, 
signaling failure. Depending on the nature of the work to be supervised and the 
nature of the failure, the supervisor has a choice of the following four 
options:</em></p>
<ul>
	<li><em>Resume the subordinate, keeping its accumulated internal state</em></li>
	<li><em>Restart the subordinate, clearing out its accumulated internal state</em></li>
	<li><em>Stop the subordinate permanently</em></li>
	<li><em>Escalate the failure to the next parent in the hierarchy, thereby failing itself</em></li>
</ul>
<p><em>It is important to always view an actor as part of a supervision hierarchy, 
which explains the existence of the fourth choice (as a supervisor also is 
subordinate to another supervisor higher up) and has implications on the first 
three: resuming an actor resumes all its subordinates, restarting an actor 
entails restarting all its subordinates (but see below for more details), 
similarly terminating an actor will also terminate all its subordinates. It 
should be noted that the default behavior of the PreRestart hook of the Actor 
class is to terminate all its children before restarting, but this hook can be 
overridden; the recursive restart applies to all children left after this hook 
has been executed.<br /><br />Each supervisor is configured with a function translating all possible failure 
causes (i.e. exceptions) into one of the four choices given above; </em></p>
<p>
<a href="http://getakka.net/docs/concepts/supervision">
http://getakka.net/docs/concepts/supervision</a></p>
<p>&nbsp;</p>
<p>In <a href="http://getakka.net/" target="_blank">Akka.NET</a> there are 2 
classes of supervision strateegy, which are as follows:</p>
<p>&nbsp;</p>
<ul>
	<li><strong>OneForOneStrategy</strong> : This means that only the failed 
	child would get the parental directive (see above) applied to it</li>
	<li><strong>AllForOneStrategy</strong> : This means that all children would 
	the get the parental directive (see above) applied to it</li>
</ul>
<p>&nbsp;</p>
<p>So that is the theory, so how does this translate to code. Each actor will 
allow you to override the supervising strategy (the default is <code>
OneForOneStrategy</code>), as shown below. I think the code block below is 
fairly self explanatory.</p>
<p>&nbsp;</p>
<p>Lets see an 
example.</p>
<pre lang="cs">
// here we are overriding the default SupervisorStrategy
// which is a One-For-One strategy w/ a Restart directive
protected override SupervisorStrategy SupervisorStrategy()
{
    return new OneForOneStrategy (
        10, // maxNumberOfRetries
        TimeSpan.FromSeconds(30), // duration
        x =&gt;
        {
            //Maybe we consider ArithmeticException to not be application critical
            //so we just ignore the error and keep going.
            if (x is ArithmeticException) return Directive.Resume;

            //Error that we cannot recover from, stop the failing actor
            else if (x is NotSupportedException) return Directive.Stop;

            //In all other cases, just restart the failing actor
            else return Directive.Restart;
        });
}
</pre>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2><a name="ActorRef" id="ActorRef">ActorRef</a></h2>
<p>As stated already an <code>IActorRef </code>is an astracted handle to an 
actual actor. By using the <code>IActorRef </code>you can perform all the common 
requirements you could expect from a
<a href="http://getakka.net/" target="_blank">Akka.NET</a> actor.</p>
<p>&nbsp;</p>
<p>Shown below is an example of what sort of methods are available to you:</p>
<p>&nbsp;</p>
<p><img alt="" height="576" src="actorRef.png" width="790" /></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3><a name="Special-ActorRefs" id="Special-ActorRefs">Special ActorRefs</a></h3>
<p>There are a few special <code>IActorRef</code>(s) that you should be aware 
of.</p>
<ul>
	<li><code>Self </code>: That is the current actor, and is only valid within 
	an actor</li>
	<li><code>Sender </code>: That is the source of a message, and is only valid 
	within an actor</li>
</ul>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3><a name="Actor-Selection" id="Actor-Selection">Actor Selection</a></h3>
<p>Whilst I highly recommend that you ensure that you always have the correct
<code>IActorRef </code>at hand, should you wish to send a message to it. With 
possibly deep/complex heirarchies this may not always be possible. But fear not
<a href="http://getakka.net/" target="_blank">Akka.NET</a> has you covered 
there. Recall I stated that there were several
<a href="http://getakka.net/" target="_blank">Akka.NET</a> level actors which 
you could not use, known as "Guardians".Well these guys form a navigation/supervision system. 
So you may use thier <code>Path</code>s along with any other actors/child actors you may have created, 
which allow to get an <code>IActorRef </code>based on what is known as an "<strong>actor 
selection</strong>" string.</p>
<p>&nbsp;</p>
<p>Here is an example:</p>
<pre lang="cs">
Context.ActorSelection("akka://MyActorSystem/user/validationActor").Tell(message);</pre>
<p>&nbsp;</p>
<p>Part of that Path ("<code>MyActorSystem</code>") comes from the place where you created the overall
<a href="http://getakka.net/" target="_blank">Akka.NET</a> actor system, which 
was like this for the demo</p>
<pre lang="cs">MyActorSystem = ActorSystem.Create("MyActorSystem");</pre>
<p>&nbsp;</p>
<p>The next part is one of the special guardians path values ("<code>user</code>") within the 
overall
<a href="http://getakka.net/" target="_blank">Akka.NET</a> actor system. From 
there it is just a case of specifying the <code>IActorRef </code>we want.</p>
<p>&nbsp;</p>
<p>You can read more about paths/selection and guardians within
<a href="http://getakka.net/" target="_blank">Akka.NET</a> here:
<a href="http://getakka.net/docs/concepts/addressing">
http://getakka.net/docs/concepts/addressing</a></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2><a name="Sending-Messages" id="Sending-Messages">Sending Messages</a></h2>
<p>Ok so we have covered a bit of ground so far, we now know the following:</p>
<ul>
	<li>There is a concept of a overall system, with guradians and our own 
	actors in it</li>
	<li>There is a concept of a supervisor (and if none is provided one of the 
	guradians will take this job on)</li>
	<li>We can use <code>IActorRef</code>(s) to do things with actors. </li>
</ul>
<p>&nbsp;</p>
<p>So its about time we did something with an actor isn't it. So lets do this. 
Lets see how we deal with sending (<code>Tell</code>) a message and receiving that within the 
destination actor.</p>
<p>&nbsp;</p>
<p>The act of sending a message in
<a href="http://getakka.net/" target="_blank">Akka.NET</a> is done using a <code>
IActorRef.Tell(..)</code>. An example of which is as follows:</p>
<pre lang="cs">consoleReaderActor.Tell(ConsoleReaderActor.StartCommand);</pre>
<p>&nbsp;</p>
<p>So now let' see how the receiver deals with this.</p>
<p>&nbsp;</p>
<p>NOTE : I am using <code>UntypedActor </code>here but there is also a <code>
TypedActor </code>if you prefer to use that, which allows you to use a generic
<code>Receive&lt;T&gt;(..)</code> methods within the constructor of your actor 
(Say. There are a whole bunch of other life cycle methods that you may override 
in an actor, I will not be covering those though, I will leave that as an 
excercise for the reader) 
instead of having just one single overriden <code>OnReceive(..)</code> method, 
where you will neeed to decode the incoming messages seen.It is a matter of 
taste.</p>
<p>&nbsp;</p>
<pre lang="cs">
class ConsoleReaderActor : UntypedActor
{
    public const string StartCommand = "start";

    protected override void OnReceive(object message)
    {
        if (message.Equals(StartCommand))
        {
           ....
        }
    }
}
</pre>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2><a name="Asking" id="Asking">Asking</a></h2>
<p>Although I do not cover this in the demo app presented here,&nbsp; providing 
you have a valid <code>IActorRef </code>you may of course ask it things. </p>
<p>This is done using the <code>Ask()</code> method.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2><a name="Special-Message-Types" id="Special-Message-Types">Special Message Types</a></h2>
<p>Within
<a href="http://getakka.net/" target="_blank">Akka.NET</a> there are a few 
special types of message. The 2 that spring to mind are:</p>
<p>&nbsp;</p>
<h3><a name="PoisonPill.Instance" id="PoisonPill.Instance">PoisonPill.Instance</a></h3>
<p>Sending a <code>Akka.Actor.PoisonPill</code> to an will stop the actor when 
the message is processed. <code>Akka.Actor.PoisonPill</code> is enqueued as 
ordinary messages and<br />
will be handled after messages that were already queued in the mailbox.</p>
<p>&nbsp;</p>
<h3><a name="Kill.Instance" id="Kill.Instance">Kill.Instance</a></h3>
<p><code>Actor.Kill</code> causes the actor to throw an <code>
Akka.Actor.ActorKilledException</code> when it processes the message, which gets 
handled using the normal supervisor mechanism, and <code>
Akka.Actor.IActorContext.Stop</code>(<code>Akka.Actor.IActorRef</code>) which 
causes the actor to stop without processing any more messages</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2><a name="Lifecycle-Methods" id="Lifecycle-Methods">Lifecycle Methods</a></h2>
<p>Each actor in
<a href="http://getakka.net/" target="_blank">Akka.NET</a> has certain lifecycle 
events that you may hook into. As such any actor you create you may choose to 
override and use these lifecycle events. The demo code doesn't cover this, but 
this diagram should help you to understand how it all works.</p>
<p>&nbsp;</p>
<p><a href="life1Big.png"><img alt="" height="602" src="life1Small.png" width="630" /></a></p>
<p><em>CLICK FOR BIGGER IMAGE</em></p>
<p>&nbsp;</p>
<p>You can read more about this here : 
<a href="http://getakka.net/docs/Actor%2520lifecycle">
http://getakka.net/docs/Actor%20lifecycle</a></p>
<p>&nbsp;</p>
<h2><a name="&nbsp;" id="&nbsp;">&nbsp;</a></h2>
<p>&nbsp;</p>
<h2><a name="Logging" id="Logging">Logging</a></h2>
<p>
<a href="http://getakka.net/" target="_blank">Akka.NET</a> has good support for 
quite a few differrent logging frameworks. These days I tend to use NLog, so 
that is what I will be showing here. There are several steps you need to follow 
to get logging workinh, which will go through below</p>
<p>&nbsp;</p>
<p><strong>Step 1 : Grab The Correct Packages</strong></p>
<p>The 1st step is to ensure you have the correct logging Dlls installed, which 
I tend to do through NuGet. So I install this package via NuGet</p>
<ul>
	<li>Akka.Logger.NLog</li>
</ul>
<p>&nbsp;</p>
<p><strong>Step 2 : Ensure App.Config Is Correct</strong></p>
<p>Then we need to make sure our main App.Config logging section is correct, 
which for the demo is as follows:</p>
<pre lang="xml">
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;configuration&gt;
  &lt;configSections&gt;
    &lt;section name="nlog" type="NLog.Config.ConfigSectionHandler, NLog"/&gt;
  &lt;/configSections&gt;

  &lt;nlog xmlns="http://www.nlog-project.org/schemas/NLog.xsd" 
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;
    &lt;targets&gt;
      &lt;target name="default" xsi:type="File"
				fileName="C:\temp\WinTail.txt"
				archiveFileName="C:\temp\WinTailArchives\WinTail-log.{#}.txt"
				archiveEvery="Day"
				archiveNumbering="Rolling"
				maxArchiveFiles="7" /&gt;
      &lt;target name="errors" xsi:type="File"
              fileName="C:\temp\WinTail_Errors.txt"
              archiveFileName="C:\temp\WinTailArchives\WinTail_Errors.{#}.txt"
              archiveEvery="Day"
              archiveNumbering="Rolling"
              maxArchiveFiles="7" /&gt;
    &lt;/targets&gt;
    &lt;rules&gt;
      &lt;logger name="*" writeTo="default" /&gt;
      &lt;logger name="*" minlevel="Error" writeTo="errors" /&gt;
    &lt;/rules&gt;
  &lt;/nlog&gt;
  

&lt;/configuration&gt;
</pre>
<p>&nbsp;</p>
<p><strong>Step 3 : Create The Logger File</strong></p>
<p>We then need to create a logger that may be used with
<a href="http://getakka.net/" target="_blank">Akka.NET</a>, which suprisre 
suprise is itself an Actor. Let' see that now shall we: </p>
<pre lang="cs">
using System;
using Akka.Actor;
using Akka.Event;
using NLog;
using NLogger = global::NLog.Logger;

namespace WinTail
{
    /// &lt;summary&gt;
    /// This class is used to receive log events and sends them to
    /// the configured NLog logger. The following log events are
    /// recognized: &lt;see cref="Debug"/&gt;, &lt;see cref="Info"/&gt;,
    /// &lt;see cref="Warning"/&gt; and &lt;see cref="Error"/&gt;.
    /// &lt;/summary&gt;
    public class NLogLogger : ReceiveActor
    {
        private readonly ILoggingAdapter log = Context.GetLogger();

        private static void Log(LogEvent logEvent, Action&lt;NLogger&gt; logStatement)
        {
            var logger = LogManager.GetLogger(logEvent.LogClass.FullName);
            logStatement(logger);
        }

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref="NLogLogger"/&gt; class.
        /// &lt;/summary&gt;
        public NLogLogger()
        {
            Receive&lt;Error&gt;(m =&gt; Log(m, logger =&gt; logger.ErrorException(m.Message.ToString(), m.Cause)));
            Receive&lt;Warning&gt;(m =&gt; Log(m, logger =&gt; logger.Warn(m.Message.ToString())));
            Receive&lt;Info&gt;(m =&gt; Log(m, logger =&gt; logger.Info(m.Message.ToString())));
            Receive&lt;Debug&gt;(m =&gt; Log(m, logger =&gt; logger.Debug(m.Message.ToString())));

            Receive&lt;InitializeLogger&gt;(m =&gt;
            {
                log.Info("NLogLogger started");
                Sender.Tell(new LoggerInitialized());
            });
        }
    }
}</pre>
<p>&nbsp;</p>
<p><strong>Step 4 :&nbsp; Include An Akka.Config (HOCON) file</strong></p>
<p>We then need to create an
<a href="http://getakka.net/" target="_blank">Akka.NET</a> config file called 
"akka.config" which should be set to "copy always" to the snure the file is 
present in the output directory. This file looks like this</p>
<p>&nbsp;</p>
<pre>akka {
stdout-loglevel = INFO
loglevel = INFO
log-config-on-start = on
loggers = ["WinTail.NLogLogger,AkkaDemo.WinTail"]
}</pre>
<p>&nbsp;</p>
<p>And is loaded like this</p>
<pre lang="cs">var config =
ConfigurationFactory.ParseString(
        File.ReadAllText(Path.Combine(Environment.CurrentDirectory, "akka.config")));

// make actor system 
MyActorSystem = ActorSystem.Create("MyActorSystem", config);

</pre>&nbsp;<p>&nbsp;</p>
<p>&nbsp;</p>
<p><strong>Step 5 :&nbsp; Let The Logging Commence</strong></p>
<p>Now with all that good stuff in place all that is left to be done is do some 
actual logging. Here is how we do that:</p>
<p>&nbsp;</p>
<pre lang="cs">
using System;
using Akka.Actor;
using Akka.Event;

namespace WinTail
{
    class ConsoleWriterActor : UntypedActor
    {
        private readonly ILoggingAdapter log = Context.GetLogger();

        protected override void OnReceive(object message)
        {
            if (message is Messages.InputError)
            {
                var msg = message as Messages.InputError;
                log.Error("Messages.InputError seen : " + msg.Reason);
				....
            }
            else if (message is Messages.InputSuccess)
            {
                var msg = message as Messages.InputSuccess;
                log.Info("Messages.InputSuccess seen : " + msg.Reason);
                ....
            }
            else
            {
                log.Info(message.ToString());
                ....
            }

            ....
        }
    }
}</pre>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2><a name="&nbsp;" id="&nbsp;">&nbsp;</a></h2>
<h2><a name="Testing" id="Testing">Testing</a></h2>
<p>In order to test
<a href="http://getakka.net/" target="_blank">Akka.NET</a> we must install a few 
more libraries, namely:</p>
<ul>
	<li>Akka.TestKit</li>
	<li>Akka.TestKit.NUnit</li>
</ul>
<p>&nbsp;</p>
<p>Both of which are available as Nuget packages. So once you have those we can 
create a simple test (I am using NUnit here), where the test may look something 
like this:</p>
<pre lang="cs">
[TestFixture]
public class TailActorTests : TestKit
{
    [Test]
    public void Show_NotifyTailActor_When_Change_Is_Made_To_File()
    {
        string fullFilePath = @"c:\temp\AkkaTest.txt";
        FileObserver fileObserver = new FileObserver(TestActor, fullFilePath);
        fileObserver.Start();
        File.WriteAllText(fullFilePath, "A test message from TailActorTests" + 
            DateTime.Now.ToString());

        ExpectMsg&lt;TailActor.FileWrite&gt;(x =&gt; fullFilePath.Contains(x.FileName) );
    }
}
</pre>
<p>&nbsp;</p>
<p>There are a couple of things to note here, such as:</p>
<ol>
	<li>We inherit from a special base class called "<code>TestKit</code>" this 
	is a special
<a href="http://getakka.net/" target="_blank">Akka.NET</a> base class that 
	allows things such as the <code>ExpectMsg&lt;T&gt;(Predicate&lt;T&gt;&gt; pred)</code> that 
	you see above</li>
	<li>There is a special <code>TestActor </code>which you may make use of</li>
	<li>As just stated we can use a <code>ExpectMsg&lt;T&gt;(Predicate&lt;T&gt;&gt; pred)</code>helper 
	methods to see if certain messages were seen by the <code>TestActor</code></li>
</ol>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2><a name="The-Actual-Demo-App" id="The-Actual-Demo-App">The Actual Demo App</a></h2>
<p>As I stated a while ago the demo app has been pretty much lifted from the
<a href="http://getakka.net/" target="_blank">Akka.NET</a> training material. 
Let's just go through what the demo app does:</p>
<ol>
	<li>There is a <code>ConsoleReaderActor</code>, which expects the user to 
	type the name of an open text file to monitor for changes.</li>
	<li>There is a <code>ValidationActor</code>, which verifies whether the user 
	typed a correct file name in</li>
	<li>There is a supervising <code>TailCoordinatorActor</code>, which gets a 
	input file, and sets up a TailActor to starts listening for changes to the 
	input file</li>
	<li>There is a <code>TailActor</code>, which will listen for changes in the 
	input file</li>
	<li>There is a <code>ConsoleWriterActor</code>, which will write out any 
	changes observed (Such as new text being input into the orginal text file 
	that is being tailed) to the console.</li>
</ol>
<p>&nbsp;</p>
<p><strong>Steps to run the demo app:</strong></p>
<ol>
	<li>Create a text file somewhere. Open this text file</li>
	<li>Run the demo app code. When asked, tell it the path of the text file you created</li>
	<li>Edit the text file you created, save it after each edit, and then watch the actor system demo show you the changes</li>
</ol>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h1><a name="That's-It" id="That's-It">That's It</a></h1>
<p>That's is all I wanted to say this time, I hope it may has been of interest 
to at least a few of you. As always if you like what you have seen, please take 
a minute to cast a vote, or leave a comment this are always appreciated</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>

</body>

</html>
